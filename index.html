<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title> 砖转 专 "住- 转</title>
<style>
:root {
--primary: #6366f1;
--accent: #10b981;
--bg: #0f172a;
--card-bg: rgba(30, 41, 59, 0.7);
--border: rgba(255, 255, 255, 0.1);
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

body {
font-family: -apple-system, system-ui, sans-serif;
margin: 0; padding: 20px; direction: rtl; color: #fff; min-height: 100vh;
background: radial-gradient(circle at 0% 0%, #4338ca 0%, #0f172a 100%);
background-attachment: fixed;
display: flex; justify-content: center;
}

.container { width: 100%; max-width: 450px; }

/*  砖专 */
.login-screen {
background: var(--card-bg); padding: 40px 30px; border-radius: 40px;
backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
border: 1px solid var(--border); box-shadow: 0 40px 100px rgba(0,0,0,0.6);
text-align: center; animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

input {
width: 100%; padding: 18px; border-radius: 18px; border: 1px solid var(--border);
background: rgba(0,0,0,0.3); color: white; margin-bottom: 15px; font-size: 16px;
}

.btn-primary {
width: 100%; padding: 18px; border-radius: 18px; border: none;
background: linear-gradient(135deg, #6366f1, #4f46e5);
color: white; font-size: 18px; font-weight: 800; cursor: pointer;
}

/* 爪 拽 砖 */
.task-card {
background: rgba(255, 255, 255, 0.06);
border-radius: 28px; padding: 20px; margin-bottom: 15px;
border: 1px solid var(--border);
transition: all 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045);
}

.task-card.removing {
transform: translateX(-150%) rotate(-15deg) scale(0.5);
opacity: 0; margin-bottom: -100px; /* 砖转 转转 注转  */
}

.task-title { font-size: 20px; font-weight: 800; margin-bottom: 10px; display: block; }

.btn-done {
background: var(--accent); color: white; padding: 15px; border-radius: 15px;
text-align: center; font-weight: 800; cursor: pointer; margin-top: 15px;
}

/* 专  */
.archive-row {
background: rgba(0,0,0,0.25); padding: 15px 20px; border-radius: 18px;
display: flex; justify-content: space-between; align-items: center;
margin-bottom: 8px; border: 1px solid var(--border);
animation: popIn 0.4s ease-out;
}

@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.undo-link { color: #818cf8; font-size: 12px; font-weight: 700; cursor: pointer; }

#imgModal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); justify-content: center; align-items: center; }
</style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" style="max-width:90%; border-radius:25px;"></div>

<div class="container">
    <div id="loginArea" class="login-screen">
        <h1 style="margin:0 0 10px 0;">砖转 砖</h1>
        <p style="color:#94a3b8; margin-bottom:30px;">转专转</p>
        <input type="text" id="studentName" placeholder="砖 ">
        <input type="text" id="classCode" placeholder="拽 转">
        <button class="btn-primary" onclick="enterClass()">住</button>
    </div>

    <div id="taskArea" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:25px;">
            <h2 id="helloName" style="margin:0;">砖</h2>
            <span onclick="logout()" style="opacity:0.5; font-size:12px; cursor:pointer;">转转拽转</span>
        </div>
        
        <p style="font-weight:800; color:#818cf8; font-size:14px; margin-bottom:15px;">砖转 </p>
        <div id="activeTasks"></div>
        
        <p style="font-weight:800; color:#818cf8; font-size:14px; margin:35px 0 15px 0;"> 专 砖转</p>
        <div id="archivedTasks"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, setDoc, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
    authDomain: "tast-7808e.firebaseapp.com",
    projectId: "tast-7808e",
    storageBucket: "tast-7808e.firebasestorage.app",
    messagingSenderId: "99024860024",
    appId: "1:99024860024:web:24ab70c10254a2014fce8d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let student = "", classCode = "";
let allTasks = [];
let completedTasks = new Set();

window.onload = () => {
    const sn = localStorage.getItem('studentName'), cc = localStorage.getItem('classCode');
    if(sn && cc) { 
        document.getElementById('studentName').value = sn; 
        document.getElementById('classCode').value = cc; 
        enterClass(); 
    }
};

window.enterClass = async () => {
    student = document.getElementById('studentName').value.trim();
    classCode = document.getElementById('classCode').value.trim().toUpperCase();
    if(!student || !classCode) return;
    localStorage.setItem('studentName', student);
    localStorage.setItem('classCode', classCode);
    
    document.getElementById('helloName').innerText = ", " + student;
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('taskArea').style.display = 'block';

    // 砖 1:   转 砖转 转 ( 专砖 专驻专砖)
    onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), (snap) => {
        allTasks = [];
        snap.forEach(d => allTasks.push({id: d.id, ...d.data()}));
        allTasks.sort((a,b) => a.endTime - b.endTime);
        refreshUI();
    });

    // 砖 2:   转 住住 爪注 砖 转
    onSnapshot(query(collection(db, "submissions"), where("studentName", "==", student), where("classCode", "==", classCode)), (snap) => {
        completedTasks.clear();
        snap.forEach(d => { if(d.data().completed) completedTasks.add(d.data().taskId); });
        refreshUI();
    });
};

function refreshUI() {
    const activeContainer = document.getElementById('activeTasks');
    const archiveContainer = document.getElementById('archivedTasks');
    
    let activeHtml = "";
    let archiveHtml = "";

    allTasks.forEach(t => {
        const isDone = completedTasks.has(t.id);
        if (!isDone) {
            activeHtml += `
                <div class="task-card" id="task_${t.id}">
                    <span class="task-title">${t.title}</span>
                    <div style="font-size:12px; opacity:0.6; margin-bottom:15px;"> 注 砖 拽专</div>
                    ${t.imageUrl ? `<img src="${t.imageUrl}" style="width:100%; border-radius:18px; margin-bottom:15px;" onclick="zoom('${t.imageUrl}')">` : ''}
                    <div class="btn-done" onclick="toggleTask('${t.id}', true)">住转 转 砖</div>
                </div>
            `;
        } else {
            archiveHtml += `
                <div class="archive-row">
                    <span>${t.title}</span>
                    <span class="undo-link" onclick="toggleTask('${t.id}', false)">专 注</span>
                </div>
            `;
        }
    });

    activeContainer.innerHTML = activeHtml;
    archiveContainer.innerHTML = archiveHtml;
}

window.toggleTask = async (id, status) => {
    const el = document.getElementById('task_' + id);
    
    if (status && el) {
        // 爪 转 (Optimistic UI) - 砖 注转 注砖!
        el.classList.add('removing');
        //  爪 砖转住转  注 住住 转
        setTimeout(async () => {
            await setDoc(doc(db, "submissions", student + "_" + id), {
                studentName: student, taskId: id, completed: status, classCode: classCode, submittedAt: Date.now()
            });
        }, 500);
    } else {
        // 拽专 砖 专 专 -  爪专 转
        await setDoc(doc(db, "submissions", student + "_" + id), {
            studentName: student, taskId: id, completed: status, classCode: classCode, submittedAt: Date.now()
        });
    }
};

window.logout = () => { localStorage.clear(); location.reload(); };
window.zoom = (url) => { document.getElementById('modalImg').src = url; document.getElementById('imgModal').style.display = 'flex'; };
</script>
</body>
</html>
