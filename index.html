<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tasks Premium">

<title> 砖转 专 "住- 转</title>
<style>
:root {
--primary: #6366f1;
--accent: #10b981;
--bg-dark: #0f172a;
--glass: rgba(30, 41, 59, 0.7);
--border: rgba(255, 255, 255, 0.1);
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }

body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
margin: 0; padding: 20px; direction: rtl; color: #fff; min-height: 100vh;
background: radial-gradient(circle at 0% 0%, #4338ca 0%, #1e1b4b 50%, #0f172a 100%);
background-attachment: fixed;
display: flex; justify-content: center;
overflow-x: hidden;
}

.container { width: 100%; max-width: 450px; position: relative; }

/* ---  拽专转 --- */
.login-card {
background: var(--glass);
padding: 40px 30px;
border-radius: 40px;
backdrop-filter: blur(30px);
-webkit-backdrop-filter: blur(30px);
border: 1px solid var(--border);
box-shadow: 0 40px 100px rgba(0,0,0,0.6);
text-align: center;
animation: cardEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes cardEntrance {
from { opacity: 0; transform: scale(0.9) translateY(40px); }
to { opacity: 1; transform: scale(1) translateY(0); }
}

.login-card h1 { font-size: 36px; font-weight: 900; margin-bottom: 10px; background: linear-gradient(to bottom, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

input {
width: 100%; padding: 20px; border-radius: 20px; border: 1px solid var(--border);
background: rgba(0,0,0,0.2); color: white; margin-bottom: 15px; font-size: 16px;
transition: all 0.3s;
}
input:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); }

.btn-main {
width: 100%; padding: 20px; border-radius: 20px; border: none;
background: linear-gradient(135deg, #6366f1, #4338ca);
color: white; font-size: 18px; font-weight: 800; cursor: pointer;
box-shadow: 0 10px 25px rgba(67, 56, 202, 0.4);
transition: transform 0.2s;
}
.btn-main:active { transform: scale(0.96); }

/* --- 砖拽 砖转 --- */
#taskArea { width: 100%; }

.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.header h2 { margin: 0; font-size: 24px; font-weight: 800; }

.section-label { font-size: 13px; font-weight: 700; color: #818cf8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: block; }

/* 爪 专驻转 砖 */
.task-box {
background: rgba(255, 255, 255, 0.05);
border-radius: 28px; padding: 22px; margin-bottom: 18px;
border: 1px solid var(--border);
position: relative;
transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
will-change: transform, opacity;
}

.task-box.removing {
animation: fastFlyOut 0.6s forwards cubic-bezier(0.5, -0.5, 0.1, 1.5);
pointer-events: none;
margin-top: -120px; /* 专  砖 注 */
opacity: 0;
}

@keyframes fastFlyOut {
    0% { transform: translateX(0) scale(1); }
    20% { transform: translateX(20px) scale(1.05); }
    100% { transform: translateX(-150%) scale(0.5) rotate(-10deg); }
}

.task-box h3 { margin: 0 0 8px 0; font-size: 20px; font-weight: 800; }
.task-meta { font-size: 13px; color: #94a3b8; margin-bottom: 15px; }

.done-btn {
background: var(--accent); color: white; padding: 16px; border-radius: 18px;
text-align: center; font-weight: 800; cursor: pointer;
box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
}

/* --- 专 专砖 转 --- */
.archive-item {
background: rgba(0,0,0,0.2);
padding: 14px 20px;
border-radius: 18px;
display: flex; justify-content: space-between; align-items: center;
margin-bottom: 10px;
border: 1px solid var(--border);
animation: fadeIn 0.5s ease-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.archive-item span { font-weight: 600; font-size: 15px; }
.undo-btn { color: #818cf8; font-size: 12px; font-weight: 700; cursor: pointer; }

#imgModal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); justify-content: center; align-items: center; }
</style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" style="max-width:90%; border-radius:30px;"></div>

<div class="container">
    <div id="loginArea" class="login-card">
        <h1>! </h1>
        <p style="color:#94a3b8; margin-bottom:30px;">转专  转 注</p>
        <input type="text" id="studentName" placeholder="砖 ">
        <input type="text" id="classCode" placeholder="拽 转 (砖 A1)">
        <button class="btn-main" onclick="enterClass()">住 注专转</button>
    </div>

    <div id="taskArea" style="display:none;">
        <div class="header">
            <h2 id="helloName">砖</h2>
            <span onclick="logout()" style="opacity:0.5; font-size: 12px; font-weight:700; cursor:pointer; border-bottom:1px solid;">转转拽转</span>
        </div>
        
        <span class="section-label"> 砖转 爪注</span>
        <div id="activeTasks"></div>
        
        <span class="section-label" style="margin-top:40px;">专 砖转</span>
        <div id="archivedTasks"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, setDoc, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
    authDomain: "tast-7808e.firebaseapp.com",
    projectId: "tast-7808e",
    storageBucket: "tast-7808e.firebasestorage.app",
    messagingSenderId: "99024860024",
    appId: "1:99024860024:web:24ab70c10254a2014fce8d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let student = "", classCode = "";

window.onload = () => {
    const sn = localStorage.getItem('studentName'), cc = localStorage.getItem('classCode');
    if(sn && cc) { 
        document.getElementById('studentName').value = sn; 
        document.getElementById('classCode').value = cc; 
        enterClass(); 
    }
};

window.enterClass = () => {
    student = document.getElementById('studentName').value.trim();
    classCode = document.getElementById('classCode').value.trim().toUpperCase();
    if(!student || !classCode) return;
    localStorage.setItem('studentName', student);
    localStorage.setItem('classCode', classCode);
    document.getElementById('helloName').innerText = ", " + student;
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('taskArea').style.display = 'block';
    listenToTasks();
};

window.logout = () => { localStorage.clear(); location.reload(); };

function listenToTasks() {
    onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), () => updateUI());
}

async function updateUI() {
    const activeContainer = document.getElementById('activeTasks');
    const archiveContainer = document.getElementById('archivedTasks');
    
    const tasksSnap = await getDocs(query(collection(db, "tasks"), where("classCode", "==", classCode)));
    let tasks = [];
    tasksSnap.forEach(d => tasks.push({id: d.id, ...d.data()}));
    tasks.sort((a,b) => a.endTime - b.endTime);

    let activeHtml = "";
    let archiveHtml = "";

    for (const t of tasks) {
        const sDoc = await getDoc(doc(db, "submissions", student + "_" + t.id));
        const done = sDoc.exists() && sDoc.data().completed;

        if (!done) {
            activeHtml += `
                <div class="task-box" id="task_${t.id}">
                    <h3>${t.title}</h3>
                    <div class="task-meta"> 注 砖 拽专</div>
                    ${t.imageUrl ? `<img src="${t.imageUrl}" style="width:100%; border-radius:20px; margin-bottom:15px;" onclick="zoom('${t.imageUrl}')">` : ''}
                    <div class="done-btn" onclick="toggleTask('${t.id}', true)">住转 爪注</div>
                </div>
            `;
        } else {
            archiveHtml += `
                <div class="archive-item">
                    <span>${t.title}</span>
                    <span class="undo-btn" onclick="toggleTask('${t.id}', false)">专</span>
                </div>
            `;
        }
    }
    activeContainer.innerHTML = activeHtml;
    archiveContainer.innerHTML = archiveHtml;
}

window.toggleTask = async (id, status) => {
    const el = document.getElementById('task_' + id);
    if(status && el) {
        el.classList.add('removing');
    }
    
    setTimeout(async () => {
        await setDoc(doc(db, "submissions", student + "_" + id), {
            studentName: student, taskId: id, completed: status, classCode: classCode, submittedAt: Date.now()
        });
        updateUI();
    }, status ? 600 : 0);
};

window.zoom = (url) => { document.getElementById('modalImg').src = url; document.getElementById('imgModal').style.display = 'flex'; };
</script>
</body>
</html>
