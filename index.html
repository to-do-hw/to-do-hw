<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="×”××©×™××•×ª ×©×œ×™">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#6366f1">

<link rel="manifest" href='data:application/manifest+json,{"name":"×”××©×™××•×ª ×©×œ×™","short_name":"××©×™××•×ª","start_url":".","display":"standalone","background_color":"#6366f1","theme_color":"#6366f1","orientation":"portrait","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/5836/5836611.png","sizes":"512x512","type":"image/png"}]}'>

<title>×”××©×™××•×ª ×©×œ×™ - ××™×•×Ÿ ×œ×¤×™ ×“×—×™×¤×•×ª</title>
<style>
:root {
--primary: #6366f1;
--glass-bg: rgba(255, 255, 255, 0.7);
--glass-border: rgba(255, 255, 255, 0.4);
--text-main: #1e293b;
--text-muted: #475569;
--accent: #10b981;
--warning: #ff823a;
}

* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
margin: 0; padding: 20px; direction: rtl; color: var(--text-main); min-height: 100vh;
display: flex; align-items: center; justify-content: center;
background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
background-size: 400% 400%; animation: gradientBG 15s ease infinite;
padding-top: calc(20px + env(safe-area-inset-top));
}

@keyframes gradientBG {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}

.container { width: 100%; max-width: 440px; margin: 0 auto; }

.main-card {
background: var(--glass-bg); padding: 35px 25px; border-radius: 30px;
backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
}

#iosPrompt {
display: none; background: var(--warning); color: white; padding: 15px;
border-radius: 20px; margin-bottom: 20px; font-size: 14px; text-align: center;
}

h2 { font-size: 28px; font-weight: 800; margin: 0 0 10px 0; color: #000; }
p.subtitle { font-size: 16px; color: var(--text-muted); margin: 0 0 30px 0; }

input {
width: 100%; padding: 16px; margin-bottom: 15px; border-radius: 15px;
border: 1px solid rgba(255,255,255,0.5); font-size: 16px;
background: rgba(255, 255, 255, 0.4); outline: none;
}

button {
width: 100%; padding: 16px; border-radius: 15px; border: none;
background: var(--primary); color: white; font-size: 17px; font-weight: 700; cursor: pointer;
}

.task-item {
background: rgba(255, 255, 255, 0.35); border-radius: 20px; padding: 20px; margin-bottom: 15px;
border: 1px solid var(--glass-border); backdrop-filter: blur(12px);
}

.check-btn {
display: flex; align-items: center; justify-content: center; gap: 10px;
padding: 14px; border-radius: 12px; background: rgba(255, 255, 255, 0.4);
border: 1px solid rgba(255, 255, 255, 0.5); cursor: pointer; font-weight: 700;
}

.check-btn.active { background: var(--accent); color: white; }

.logout-link {
font-size: 14px; color: var(--text-muted); background: rgba(255,255,255,0.3);
border: 1px solid var(--glass-border); padding: 6px 15px; border-radius: 10px; cursor: pointer;
}

.task-img { width: 100%; border-radius: 15px; margin-bottom: 15px; cursor: pointer; }
.badge { font-size: 11px; font-weight: 800; padding: 4px 12px; border-radius: 12px; }
.badge-active { background: rgba(16, 185, 129, 0.2); color: #065f46; }
.badge-expired { background: rgba(239, 68, 68, 0.2); color: #991b1b; }
.badge-tomorrow { background: rgba(255, 130, 58, 0.2); color: #7c2d12; }

#imgModal {
display: none; position: fixed; inset: 0; z-index: 1000;
background: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center;
}
</style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" style="max-width:90%; border-radius:15px;"></div>

<div class="container">
    <div id="iosPrompt">
        ×œ×”×ª×§× ×”: ×œ×—×¥ ×¢×œ <strong>×©×™×ª×•×£</strong> ×•××– ×¢×œ <strong>"×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"</strong>
    </div>

    <div class="main-card">
        <div id="loginArea">
            <h2>×”×™×™ ×œ×š! ğŸ‘‹</h2>
            <p class="subtitle">×”×–×Ÿ ×¤×¨×˜×™× ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ××©×™××•×ª</p>
            <input type="text" id="studentName" placeholder="××™×š ×§×•×¨××™× ×œ×š?">
            <input type="text" id="classCode" placeholder="×§×•×“ ×›×™×ª×”">
            <button onclick="enterClass()">×›× ×™×¡×” ×œ×—×“×¨ ×”××©×™××•×ª</button>
        </div>

        <div id="taskArea" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                <div>
                    <p style="margin:0; font-size: 14px; color: var(--text-muted);">×©×œ×•×,</p>
                    <h2 id="helloName" style="margin:0;">×ª×œ××™×“/×”</h2>
                </div>
                <button class="logout-link" onclick="logout()">×”×ª× ×ª×§×•×ª</button>
            </div>
            <div id="tasksList"></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, setDoc, doc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
    authDomain: "tast-7808e.firebaseapp.com",
    projectId: "tast-7808e",
    storageBucket: "tast-7808e.firebasestorage.app",
    messagingSenderId: "99024860024",
    appId: "1:99024860024:web:24ab70c10254a2014fce8d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = "";
let classCode = "";
let knownTaskIds = new Set();
let isFirstLoad = true;

window.onload = async () => {
    const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isStandalone = ('standalone' in window.navigator) && (window.navigator.standalone);
    if (isIos && !isStandalone) document.getElementById('iosPrompt').style.display = 'block';

    const savedName = localStorage.getItem('studentName');
    const savedCode = localStorage.getItem('classCode');
    if (savedName && savedCode) {
        document.getElementById('studentName').value = savedName;
        document.getElementById('classCode').value = savedCode;
        enterClass(true);
    }
};

async function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") await Notification.requestPermission();
}

function sendNotification(title, message) {
    if (Notification.permission === "granted") new Notification(title, { body: message, icon: "https://cdn-icons-png.flaticon.com/512/5836/5836611.png" });
}

window.enterClass = async (isAuto = false) => {
    student = document.getElementById('studentName').value.trim();
    classCode = document.getElementById('classCode').value.trim().toUpperCase();
    if(!student || !classCode) return;

    try {
        const q = query(collection(db, "classes"), where("code", "==", classCode));
        const snap = await getDocs(q);
        if(snap.empty) { if(!isAuto) alert("×§×•×“ ×›×™×ª×” ×œ× × ××¦×"); return; }

        requestNotificationPermission();
        localStorage.setItem('studentName', student);
        localStorage.setItem('classCode', classCode);
        document.getElementById('helloName').innerText = student;
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('taskArea').style.display = 'block';
        loadTasks();
    } catch (err) { console.error(err); }
};

window.logout = () => { if(confirm("×œ×”×ª× ×ª×§?")) { localStorage.clear(); location.reload(); } };

function loadTasks() {
    onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), (snap) => {
        const list = document.getElementById('tasksList');
        list.innerHTML = '';
        const now = Date.now();
        
        // ×”××¨×ª ×”××©×™××•×ª ×œ××¢×¨×š ×›×“×™ ×©× ×•×›×œ ×œ××™×™×Ÿ ××•×ª×•
        let tasks = [];
        snap.forEach(doc => {
            tasks.push({ id: doc.id, ...doc.data() });
        });

        // ××™×•×Ÿ ×”××©×™××•×ª: ××œ×• ×©××¡×ª×™×™××•×ª ×§×•×“× ×™×•×¤×™×¢×• ×¨××©×•× ×•×ª
        tasks.sort((a, b) => a.endTime - b.endTime);

        tasks.forEach(async (t) => {
            const taskId = t.id;

            if (!isFirstLoad && !knownTaskIds.has(taskId) && now >= t.startTime) {
                sendNotification("××©×™××” ×—×“×©×”! ğŸ“", t.title);
            }
            knownTaskIds.add(taskId);

            if (now < t.startTime) return;

            const isExpired = now > t.endTime;
            const isTomorrow = (t.endTime - now) > 0 && (t.endTime - now) < 86400000;

            const dateObj = new Date(t.endTime);
            const displayDate = dateObj.toLocaleDateString('he-IL', { weekday: 'long', day: '2-digit', month: '2-digit' }) 
                                + " ×‘×©×¢×” " + dateObj.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = 'task-item';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-weight:700;">${t.title}</span>
                    <span class="badge ${isExpired ? 'badge-expired' : (isTomorrow ? 'badge-tomorrow' : 'badge-active')}">
                        ${isExpired ? '×‘××™×—×•×¨' : (isTomorrow ? '×œ××—×¨' : '×¤×¢×™×œ')}
                    </span>
                </div>
                <div style="font-size:13px; color:var(--text-muted); margin-bottom:15px;">ğŸ•’ ×”×’×©×” ×¢×“: ${displayDate}</div>
                ${t.imageUrl ? `<img src="${t.imageUrl}" class="task-img" onclick="zoom('${t.imageUrl}')">` : ''}
                <div class="check-btn" id="btn_${taskId}" onclick="toggleTask('${taskId}')">
                    <span id="icon_${taskId}">â¬œ</span>
                    <span id="text_${taskId}">×¡×× ×• ×›×©×¡×™×™××ª×</span>
                </div>
            `;
            list.appendChild(div);

            onSnapshot(doc(db, "submissions", student + "_" + taskId), (sDoc) => {
                const btn = document.getElementById(`btn_${taskId}`);
                if(sDoc.exists() && sDoc.data().completed) {
                    btn.classList.add('active');
                    document.getElementById(`icon_${taskId}`).innerText = 'âœ…';
                    document.getElementById(`text_${taskId}`).innerText = '×”××©×™××” ×‘×•×¦×¢×”!';
                } else {
                    btn.classList.remove('active');
                    document.getElementById(`icon_${taskId}`).innerText = 'â¬œ';
                    document.getElementById(`text_${taskId}`).innerText = '×¡×× ×• ×›×©×¡×™×™××ª×';
                }
            });
        });
        isFirstLoad = false;
    });
}

window.toggleTask = async (id) => {
    const btn = document.getElementById(`btn_${id}`);
    const currentStatus = btn.classList.contains('active');
    await setDoc(doc(db, "submissions", student + "_" + id), {
        studentName: student, taskId: id, completed: !currentStatus, classCode: classCode, submittedAt: Date.now()
    });
};

window.zoom = (url) => {
    document.getElementById('modalImg').src = url;
    document.getElementById('imgModal').style.display = 'flex';
};
</script>
</body>
</html>
