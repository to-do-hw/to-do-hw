<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title> 专 "住 - 砖拽 转  </title>
<style>
:root {
--bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #4338ca 100%);
--glass: rgba(255, 255, 255, 0.12);
--glass-border: rgba(255, 255, 255, 0.25);
--accent: #10b981;
}

body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 15px; direction: rtl; min-height: 100vh; background: var(--bg-gradient); color: white; overflow-x: hidden; }

/*  专 注 */
.stats-header { background: var(--glass); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--glass-border); }
.progress-container { background: rgba(0,0,0,0.3); height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
#progressBar { background: var(--accent); height: 100%; width: 0%; transition: 1s; }
.gold-mode { box-shadow: 0 0 15px #fbbf24; border-color: #fbbf24 !important; }

/* 专 驻拽住 住 专转 */
#focusSetupModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
#timerOverlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }

.task-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 25px; padding: 20px; margin-bottom: 20px; position: relative; }
.btn-main { width: 100%; padding: 15px; border-radius: 15px; border: none; background: white; color: #1e3a8a; font-weight: bold; cursor: pointer; }
.focus-btn { background: #60a5fa; color: white; margin-top: 10px; }

.modal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(15, 23, 42, 0.92); backdrop-filter: blur(20px); padding: 30px 15px; }
.hidden { display: none; }
input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: white; text-align: center; }
</style>
</head>
<body>

<div id="focusSetupModal">
    <h2>锔 专转 专</h2>
    <label> 拽转?</label>
    <input type="number" id="focusMins" value="25">
    
    <label>爪注 砖注:</label>
    <select id="timerColor">
        <option value="#60a5fa"> 砖</option>
        <option value="#f472b6">专 住拽</option>
        <option value="#34d399">专拽 专注</option>
        <option value="#ffffff"> 拽</option>
    </select>

    <label> 砖注:</label>
    <select id="timerSize">
        <option value="80px">专</option>
        <option value="120px"></option>
        <option value="160px">注拽</option>
    </select>

    <label>拽砖专 拽 () - 驻爪:</label>
    <input type="text" id="ytLink" placeholder="拽 拽  砖专 专拽 拽转 驻">

    <button class="btn-main" style="background:var(--accent); color:white; margin-top:20px;" onclick="launchTimer()">转 注砖! </button>
    <button onclick="document.getElementById('focusSetupModal').style.display='none'" style="background:none; color:white; margin-top:10px; border:none; cursor:pointer;"></button>
</div>

<div id="timerOverlay">
    <div id="timerClock" style="font-weight: 900; transition: 0.3s;">00:00</div>
    <div id="ytContainer" style="margin-top:20px; width: 90%; max-width: 400px; height: 80px; overflow: hidden; border-radius: 15px;">
        <iframe id="ytPlayer" width="100%" height="300" src="" frameborder="0" allow="autoplay"></iframe>
    </div>
    <div style="display:flex; gap:10px; margin-top:30px;">
        <button class="btn-main" style="width:120px; background:#444; color:white;" onclick="changeMusic()">祝 拽</button>
        <button class="btn-main" style="width:120px; background:#ef4444; color:white;" onclick="stopFocus()">爪</button>
    </div>
</div>

<div class="main-container">
    <div id="loginArea" class="glass-panel">
        <h2 style="text-align:center;">专 "住 - 转</h2>
        <input type="text" id="studentName" placeholder="砖 ">
        <input type="text" id="classCode" placeholder="拽 转">
        <button class="btn-main" onclick="enterClass()">住</button>
    </div>

    <div id="taskArea" class="hidden">
        <div class="stats-header" id="statsBox">
            <div style="display:flex; justify-content:space-between;">
                <span id="pointsDisplay"> 拽转: 0</span>
                <span id="dailyMinutes"> 专 : 0/60 拽'</span>
            </div>
            <div class="progress-container"><div id="progressBar"></div></div>
        </div>

        <div id="helloName" style="font-size: 24px; font-weight: 800; margin-bottom: 20px;"></div>
        <div id="activeTasks"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, doc, getDocs, updateDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk", authDomain: "tast-7808e.firebaseapp.com", projectId: "tast-7808e", storageBucket: "tast-7808e.firebasestorage.app", messagingSenderId: "99024860024", appId: "1:99024860024:web:24ab70c10254a2014fce8d" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = "", classCode = "", focusInterval, currentMins = 0;
const lofiList = ["jfKfPfyJRdk", "n61ULEU7FZ0", "5yx6BWbL1E4"];
let lofiIdx = 0;

window.enterClass = async () => {
    student = document.getElementById('studentName').value.trim();
    classCode = document.getElementById('classCode').value.trim().toUpperCase();
    if(!student || !classCode) return;
    const snap = await getDocs(query(collection(db, "classes"), where("code", "==", classCode)));
    if(snap.empty) return alert("拽 砖");
    localStorage.setItem('studentName', student);
    localStorage.setItem('classCode', classCode);
    document.getElementById('loginArea').classList.add('hidden');
    document.getElementById('taskArea').classList.remove('hidden');
    document.getElementById('helloName').innerText = " " + student;
    updateStats();
    loadTasks();
};

function loadTasks() {
    onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), (tSnap) => {
        const act = document.getElementById('activeTasks');
        act.innerHTML = '';
        tSnap.forEach(tDoc => {
            const t = tDoc.data();
            act.innerHTML += `
                <div class="task-card">
                    <div style="font-weight:900; font-size:20px;">${t.title}</div>
                    <button class="btn-main focus-btn" onclick="openFocusSetup()">憋 转 驻拽住</button>
                </div>`;
        });
    });
}

window.openFocusSetup = () => { document.getElementById('focusSetupModal').style.display = 'flex'; };

window.launchTimer = () => {
    const mins = parseInt(document.getElementById('focusMins').value);
    const color = document.getElementById('timerColor').value;
    const size = document.getElementById('timerSize').value;
    const yt = document.getElementById('ytLink').value;

    currentMins = mins;
    document.getElementById('focusSetupModal').style.display = 'none';
    document.getElementById('timerOverlay').style.display = 'flex';
    
    const clock = document.getElementById('timerClock');
    clock.style.color = color;
    clock.style.fontSize = size;

    // 
    let videoId = lofiList[0];
    if(yt.includes("v=")) videoId = yt.split("v=")[1].split("&")[0];
    else if(yt.includes("be/")) videoId = yt.split("be/")[1].split("?")[0];
    document.getElementById('ytPlayer').src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

    let time = mins * 60;
    focusInterval = setInterval(() => {
        time--;
        let m = Math.floor(time / 60), s = time % 60;
        clock.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if(time <= 0) finishFocus();
    }, 1000);
};

function finishFocus() {
    clearInterval(focusInterval);
    const today = new Date().toLocaleDateString();
    let total = parseInt(localStorage.getItem('focus_' + today)) || 0;
    let points = parseInt(localStorage.getItem('points')) || 0;
    
    total += currentMins;
    points += (currentMins * 10); // 10 拽转  拽
    
    localStorage.setItem('focus_' + today, total);
    localStorage.setItem('points', points);
    
    alert(` ! 专转 ${currentMins * 10} 拽转!`);
    stopFocus();
    updateStats();
}

window.stopFocus = () => {
    clearInterval(focusInterval);
    document.getElementById('timerOverlay').style.display = 'none';
    document.getElementById('ytPlayer').src = "";
};

window.changeMusic = () => {
    lofiIdx = (lofiIdx + 1) % lofiList.length;
    document.getElementById('ytPlayer').src = `https://www.youtube.com/embed/${lofiList[lofiIdx]}?autoplay=1`;
};

function updateStats() {
    const today = new Date().toLocaleDateString();
    const total = parseInt(localStorage.getItem('focus_' + today)) || 0;
    const points = localStorage.getItem('points') || 0;
    const target = 60;
    
    document.getElementById('pointsDisplay').innerText = ` 拽转: ${points}`;
    document.getElementById('dailyMinutes').innerText = ` 专: ${total}/${target} 拽'`;
    
    const percent = Math.min((total / target) * 100, 100);
    document.getElementById('progressBar').style.width = percent + "%";
    
    if(total >= target) document.getElementById('statsBox').classList.add('gold-mode');
}

window.onload = () => {
    if(localStorage.getItem('studentName')) enterClass();
};
</script>
</body>
</html>
