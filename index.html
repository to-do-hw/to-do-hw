<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>×¨××œ×™ ××˜×•"×¡ - ×××©×§ ×ª×œ××™×“×™×</title>
<style>
    :root {
        --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #4338ca 100%);
        --glass: rgba(255, 255, 255, 0.12);
        --glass-border: rgba(255, 255, 255, 0.25);
        --accent: #10b981; --danger: #ef4444;
        --sun-color: #fbbf24; --mon-color: #f87171; --tue-color: #34d399; --wed-color: #60a5fa; --thu-color: #c084fc;
    }

    body {
        font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 15px;
        direction: rtl; min-height: 100vh; color: white;
        background: var(--bg-gradient); background-attachment: fixed;
    }

    .glass-panel {
        background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 25px; border: 1px solid var(--glass-border); padding: 20px; margin-bottom: 15px;
    }

    /* ×˜××‘×™× ×§×˜× ×™× ×œ××¢×œ×” */
    .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; }
    .tab { 
        padding: 8px 15px; border-radius: 12px; background: rgba(255,255,255,0.1); 
        cursor: pointer; font-size: 13px; border: 1px solid var(--glass-border); white-space: nowrap;
    }
    .tab.active { background: white; color: #1e3a8a; font-weight: bold; }

    /* ×›×¨×˜×™×¡×™×™×ª ××©×™××” - ×‘×“×™×•×§ ×›××• ×‘××§×•×¨ */
    .task-card {
        background: rgba(255, 255, 255, 0.15); border-radius: 25px; padding: 20px;
        margin-bottom: 20px; border: 1px solid var(--glass-border);
    }

    .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .task-title { font-size: 19px; font-weight: bold; margin: 0; }
    .task-date { font-size: 12px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 10px; }

    .img-preview { width: 100%; border-radius: 15px; margin: 10px 0; border: 1px solid var(--glass-border); cursor: zoom-in; }

    /* ×›×¤×ª×•×¨×™× ×œ× ××’×•×©××™× */
    .btn-row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 10px; margin-top: 15px; }
    button { 
        padding: 12px; border-radius: 15px; border: none; font-weight: bold; 
        font-size: 14px; cursor: pointer; transition: 0.2s;
    }
    .btn-main { background: white; color: #1e3a8a; }
    .btn-sub { background: rgba(255,255,255,0.15); color: white; border: 1px solid white; }

    /* ××¢×¨×›×ª ×©×¢×•×ª ××§×•×¨×™×ª */
    .schedule-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
    .day-col { min-width: 140px; background: rgba(0,0,0,0.25); border-radius: 20px; padding: 12px; }
    .lesson-box {
        background: rgba(255,255,255,0.08); border-radius: 12px; padding: 10px; margin-top: 10px;
        font-size: 13px; text-align: center; border-right: 4px solid white;
    }

    input { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 15px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: white; box-sizing: border-box; font-size: 16px; }
    .hidden { display: none; }
    #notifBanner { background: var(--accent); color: white; padding: 12px; text-align: center; border-radius: 15px; margin-bottom: 15px; font-weight: bold; }
    
    .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); padding: 20px; box-sizing: border-box; overflow-y: auto; }
</style>
</head>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDocs, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ×”×’×“×¨×•×ª Firebase ×”××§×•×¨×™×•×ª
    const firebaseConfig = {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let student = "";
    let classCode = "";

    // ×¤×•× ×§×¦×™×™×ª ×˜××‘×™× ××œ××”
    window.switchTab = (tabName) => {
        const tabs = document.querySelectorAll('.tab');
        const contents = ['active', 'archive', 'schedule'];
        
        tabs.forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');

        contents.forEach(id => {
            document.getElementById('tab-' + id).classList.add('hidden');
        });
        document.getElementById('tab-' + tabName).classList.remove('hidden');
    };

    // ×¤×•× ×§×¦×™×™×ª ×›× ×™×¡×” ××§×•×¨×™×ª
    window.enterClass = async () => {
        student = document.getElementById('studentName').value.trim();
        classCode = document.getElementById('classCode').value.trim().toUpperCase();
        
        if (!student || !classCode) {
            alert("×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª");
            return;
        }

        const q = query(collection(db, "classes"), where("code", "==", classCode));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            alert("×§×•×“ ×›×™×ª×” ×œ× × ××¦× ×‘××¢×¨×›×ª");
            return;
        }

        localStorage.setItem('studentName', student);
        localStorage.setItem('classCode', classCode);
        
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('taskArea').classList.remove('hidden');
        document.getElementById('helloTitle').innerText = `×”×™×™, ${student} ğŸ‘‹`;

        // ×”×¤×¢×œ×ª ×”×ª×¨××•×ª ×•×˜×¢×™× ×ª × ×ª×•× ×™×
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }
        
        startApp();
    };

    function startApp() {
        loadSchedule();
        loadTasks();
        listenForNotifications();
        updateActivity();
        setInterval(updateActivity, 120000); // ×¢×“×›×•×Ÿ ×›×œ 2 ×“×§×•×ª
    }

    // ×”××–× ×” ×œ×”×ª×¨××•×ª (×—×“×©)
    function listenForNotifications() {
        const q = query(collection(db, "notifications"), where("classCode", "==", classCode));
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const now = Date.now();
                    const notifTime = data.timestamp?.toMillis() || 0;
                    
                    if (now - notifTime < 15000) { // ×”×ª×¨××” ×¨×§ ×¢×œ ××©×™××•×ª ××”-15 ×©× ×™×•×ª ×”××—×¨×•× ×•×ª
                        document.getElementById('notifBanner').classList.remove('hidden');
                        if (Notification.permission === "granted") {
                            new Notification("××©×™××” ×—×“×©×” ××”××•×¨×”!", { body: data.body });
                        }
                    }
                }
            });
        });
    }

    // ×˜×¢×™× ×ª ××¢×¨×›×ª ×©×¢×•×ª ×”××§×•×¨×™×ª
    function loadSchedule() {
        const q = query(collection(db, "classes"), where("code", "==", classCode));
        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) return;
            const classData = snapshot.docs[0].data();
            const schedule = classData.schedule || {};
            const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™"];
            const colors = ["--sun-color", "--mon-color", "--tue-color", "--wed-color", "--thu-color"];
            
            let html = "";
            days.forEach((day, i) => {
                const dayLessons = schedule[`day${i}`] || [];
                html += `
                    <div class="day-col">
                        <div style="color: var(${colors[i]}); font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 16px;">${day}</div>
                        ${dayLessons.map(l => `
                            <div class="lesson-box" style="border-color: var(${colors[i]});">
                                <div style="font-weight: bold; color: white;">${l.subject}</div>
                                <div style="font-size: 11px; opacity: 0.8;">${l.time}</div>
                            </div>
                        `).join('')}
                    </div>`;
            });
            document.getElementById('scheduleContainer').innerHTML = html;
        });
    }

    // ×˜×¢×™× ×ª ××©×™××•×ª ×•××¨×›×™×•×Ÿ ×”××§×•×¨×™×ª
    function loadTasks() {
        const tasksQuery = query(collection(db, "tasks"), where("classCode", "==", classCode));
        onSnapshot(tasksQuery, (tasksSnapshot) => {
            const submissionsQuery = query(collection(db, "submissions"), where("studentName", "==", student));
            onSnapshot(submissionsQuery, (subsSnapshot) => {
                const completedTasks = {};
                subsSnapshot.forEach(doc => {
                    if (doc.data().completed) completedTasks[doc.data().taskId] = true;
                });

                const activeList = document.getElementById('tab-active');
                const archiveList = document.getElementById('tab-archive');
                activeList.innerHTML = "";
                archiveList.innerHTML = "";

                tasksSnapshot.forEach((docSnap) => {
                    const task = docSnap.data();
                    const taskId = docSnap.id;
                    const isDone = completedTasks[taskId] || false;
                    const dateStr = new Date(task.endTime).toLocaleDateString('he-IL', {day: 'numeric', month: 'numeric'});

                    const taskHtml = `
                        <div class="task-card">
                            <div class="task-header">
                                <h3 class="task-title">${task.title}</h3>
                                <span class="task-date">×¢×“ ×”-${dateStr}</span>
                            </div>
                            
                            ${task.imageUrl ? `<img src="${task.imageUrl}" class="img-preview" onclick="zoom('${task.imageUrl}')">` : ''}
                            
                            <div class="btn-row">
                                <button class="btn-main" onclick="toggleTask('${taskId}', ${isDone})" 
                                    style="background: ${isDone ? 'var(--accent)' : 'white'}; color: ${isDone ? 'white' : '#1e3a8a'};">
                                    ${isDone ? '×‘×•×¦×¢ âœ…' : '×¡×™×™××ª×™!'}
                                </button>
                                <button class="btn-sub" onclick="uploadWorksheet('${taskId}')">ğŸ“¸ ×¦×œ× ×“×£</button>
                            </div>

                            ${task.worksheetBy === student ? `
                                <div style="text-align: center; margin-top: 12px; font-size: 13px;">
                                    <span onclick="viewWS('${taskId}')" style="color: var(--accent); cursor: pointer; text-decoration: underline;">×¦×¤×” ×‘×“×£ ×©×œ×™</span> | 
                                    <span onclick="deleteWS('${taskId}')" style="color: var(--danger); cursor: pointer; text-decoration: underline;">××—×§</span>
                                </div>
                            ` : ''}
                        </div>`;

                    if (isDone) archiveList.innerHTML += taskHtml;
                    else activeList.innerHTML += taskHtml;
                });
            });
        });
    }

    // ×¤×•× ×§×¦×™×•×ª ×”×¢×œ××” ×•× ×™×”×•×œ ×“×¤×™× ×”××§×•×¨×™×•×ª
    window.uploadWorksheet = (id) => {
        const inp = document.createElement('input');
        inp.type = 'file';
        inp.accept = 'image/*';
        inp.onchange = async (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const b64 = ev.target.result;
                await updateDoc(doc(db, "tasks", id), { 
                    worksheets: [b64], 
                    worksheetBy: student 
                });
                alert("×”×“×¤×™× ×”×•×¢×œ×• ×‘×”×¦×œ×—×”!");
            };
            reader.readAsDataURL(file);
        };
        inp.click();
    };

    window.viewWS = async (id) => {
        const d = await getDocs(collection(db, "tasks"));
        const t = d.docs.find(doc => doc.id === id).data();
        document.getElementById('wsGrid').innerHTML = (t.worksheets || []).map(img => `
            <img src="${img}" style="width:100%; border-radius:15px; margin-bottom:10px; border: 1px solid var(--glass-border);">
        `).join('');
        document.getElementById('wsViewModal').style.display = 'block';
    };

    window.deleteWS = async (id) => {
        if (confirm("×”×× ×œ××—×•×§ ××ª ×“×¤×™ ×”×¢×‘×•×“×” ×©×”×¢×œ×™×ª?")) {
            await updateDoc(doc(db, "tasks", id), { worksheets: null, worksheetBy: null });
        }
    };

    window.toggleTask = async (tid, isDone) => {
        await setDoc(doc(db, "submissions", student + "_" + tid), { 
            studentName: student, 
            taskId: tid, 
            completed: !isDone, 
            classCode: classCode 
        });
    };

    window.zoom = (url) => {
        document.getElementById('modalImg').src = url;
        document.getElementById('imgModal').style.display = 'block';
    };

    window.logout = () => {
        localStorage.clear();
        location.reload();
    };

    function updateActivity() {
        setDoc(doc(db, "activity", student + "_" + classCode), { 
            name: student, 
            classCode: classCode, 
            lastSeen: serverTimestamp() 
        }, { merge: true });
    }

    // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª
    window.onload = () => {
        const n = localStorage.getItem('studentName');
        const c = localStorage.getItem('classCode');
        if (n && c) {
            document.getElementById('studentName').value = n;
            document.getElementById('classCode').value = c;
            enterClass();
        }
    };
</script>
</body>
</html>
<body>
