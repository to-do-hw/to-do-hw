<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>×¨××œ×™ ××˜×•"×¡ - ×××©×§ ×ª×œ××™×“</title>
<style>
    :root {
        --bg: #0f172a; --glass: rgba(255, 255, 255, 0.08);
        --accent: #10b981; --danger: #ef4444; --border: rgba(255, 255, 255, 0.15);
    }
    body {
        font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 10px; 
        direction: rtl; background: var(--bg); color: white;
    }
    .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 12px; }
    
    /* ×˜××‘×™× */
    .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; background: rgba(255,255,255,0.05); cursor: pointer; font-weight: bold; font-size: 14px; }
    .tab.active { background: var(--accent); color: white; }

    /* ×¨×©×™××ª ××©×™××•×ª ×§×•××¤×§×˜×™×ª */
    .task-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; margin-bottom: 10px; border-right: 4px solid var(--danger); }
    .task-card.completed { border-right-color: var(--accent); opacity: 0.8; }
    .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .task-title { font-weight: bold; font-size: 16px; margin: 0; }
    .task-date { font-size: 11px; opacity: 0.6; }
    
    .img-thumb { width: 100%; border-radius: 8px; margin: 8px 0; max-height: 150px; object-fit: cover; cursor: zoom-in; }
    
    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; }
    .btn-main { background: var(--accent); color: white; }
    .btn-outline { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border); }

    input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: white; box-sizing: border-box; }
    
    /* ××¢×¨×›×ª ×©×¢×•×ª ××™× ×™××œ×™×¡×˜×™×ª */
    .sched-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
    .day-box { min-width: 100px; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px; font-size: 12px; }
    .lesson { margin-top: 5px; padding: 4px; background: rgba(255,255,255,0.05); border-radius: 5px; font-size: 11px; }

    .hidden { display: none; }
    .notif-bar { background: var(--accent); color: white; padding: 8px; text-align: center; border-radius: 8px; margin-bottom: 10px; font-size: 13px; font-weight: bold; }
</style>
</head>
<body>

<div id="loginArea" class="glass" style="margin-top: 50px;">
    <h2 style="text-align:center;">×›× ×™×¡×ª ×ª×œ××™×“ ğŸš€</h2>
    <input type="text" id="studentName" placeholder="×©× ××œ×">
    <input type="text" id="classCode" placeholder="×§×•×“ ×›×™×ª×”">
    <button class="btn-main" style="width:100%; padding:15px;" onclick="enterClass()">×›× ×™×¡×”</button>
</div>

<div id="taskArea" class="hidden">
    <div id="notifBanner" class="notif-bar hidden">ğŸ”” ××©×™××” ×—×“×©×” × ×•×¡×¤×”!</div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <span id="helloTitle" style="font-weight:bold;"></span>
        <button onclick="logout()" style="background:none; color:var(--danger); font-size:12px;">×”×ª× ×ª×§</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('active')">××©×™××•×ª ×œ×‘×™×¦×•×¢</div>
        <div class="tab" onclick="switchTab('archive')">××¨×›×™×•×Ÿ (×”×•×’×©×•)</div>
        <div class="tab" onclick="switchTab('schedule')">××¢×¨×›×ª</div>
    </div>

    <div id="tab-active">
        <div id="activeTasks"></div>
    </div>

    <div id="tab-archive" class="hidden">
        <div id="archivedTasks"></div>
    </div>

    <div id="tab-schedule" class="hidden">
        <div class="glass">
            <div id="scheduleContainer" class="sched-grid"></div>
        </div>
    </div>
</div>

<div id="imgModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; text-align:center;" onclick="this.style.display='none'">
    <img id="modalImg" style="max-width:95%; max-height:90%; margin-top:20px; border-radius:10px;">
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDocs, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let student = "", classCode = "";

    // ×¤×•× ×§×¦×™×™×ª ×”×ª×¨××•×ª ×—×“×©×”
    async function initNotifications() {
        if ("Notification" in window && Notification.permission !== "granted") {
            await Notification.requestPermission();
        }
    }

    // ×”××–× ×” ×œ×”×ª×¨××•×ª ×‘×–××Ÿ ×××ª
    function listenForNotifications() {
        const q = query(collection(db, "notifications"), where("classCode", "==", classCode));
        onSnapshot(q, (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const isRecent = (Date.now() - data.timestamp?.toMillis()) < 10000;
                    if (isRecent) {
                        document.getElementById('notifBanner').classList.remove('hidden');
                        if (Notification.permission === "granted") {
                            new Notification("××©×™××” ×—×“×©×” ×¤×•×¨×¡××”!", { body: data.body });
                        }
                    }
                }
            });
        });
    }

    window.enterClass = async () => {
        student = document.getElementById('studentName').value.trim();
        classCode = document.getElementById('classCode').value.trim().toUpperCase();
        if(!student || !classCode) return;

        const snap = await getDocs(query(collection(db, "classes"), where("code", "==", classCode)));
        if(snap.empty) return alert("×§×•×“ ×›×™×ª×” ×œ× × ××¦×");

        localStorage.setItem('studentName', student);
        localStorage.setItem('classCode', classCode);
        
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('taskArea').classList.remove('hidden');
        document.getElementById('helloTitle').innerText = "×”×™×™ " + student;

        initNotifications();
        listenForNotifications();
        loadSchedule();
        loadTasks();
        updateActivity();
    };

    function loadSchedule() {
        onSnapshot(query(collection(db, "classes"), where("code", "==", classCode)), (snap) => {
            if(snap.empty) return;
            const sched = snap.docs[0].data().schedule || {};
            const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™"];
            const colors = ["--sun-color", "--mon-color", "--tue-color", "--wed-color", "--thu-color"];
            
            document.getElementById('scheduleContainer').innerHTML = days.map((day, i) => {
                const lessons = sched[`day${i}`] || [];
                return `<div class="day-col">
                    <b style="color:var(${colors[i]})">${day}</b>
                    ${lessons.map(l => `<div class="lesson-box" style="border-color:var(${colors[i]})">${l.subject}<br>${l.time}</div>`).join('')}
                </div>`;
            }).join('');
        });
    }

    function loadTasks() {
        onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), (tSnap) => {
            onSnapshot(query(collection(db, "submissions"), where("studentName", "==", student)), (sSnap) => {
                const subs = {};
                sSnap.forEach(d => { if(d.data().completed) subs[d.data().taskId] = true; });

                const activeContainer = document.getElementById('activeTasks');
                const archiveContainer = document.getElementById('archivedTasks');
                activeContainer.innerHTML = ''; archiveContainer.innerHTML = '';

                tSnap.forEach(docSnap => {
                    const t = docSnap.data();
                    const tid = docSnap.id;
                    const isDone = subs[tid] || false;
                    const hasWS = t.worksheetBy === student;

                    const html = `
                        <div class="task-card ${isDone ? 'completed' : ''}">
                            <div class="task-header">
                                <span class="task-title">${t.title}</span>
                                <span class="task-date">${new Date(t.endTime).toLocaleDateString('he-IL')}</span>
                            </div>
                            ${t.imageUrl ? `<img src="${t.imageUrl}" class="img-thumb" onclick="zoom('${t.imageUrl}')">` : ''}
                            <div class="btn-row">
                                <button class="btn-main" onclick="toggleTask('${tid}', ${isDone})">${isDone ? '×”×—×–×¨ ×œ××©×™××•×ª' : '×‘×•×¦×¢ âœ…'}</button>
                                <button class="btn-outline" onclick="uploadWS('${tid}')">ğŸ“¸ ×¦×œ× ×“×£</button>
                            </div>
                            ${hasWS ? `<div style="text-align:center; margin-top:5px; font-size:11px;">
                                <span onclick="viewWS('${tid}')" style="color:var(--accent); cursor:pointer;">×¦×¤×” ×‘×“×£</span> | 
                                <span onclick="deleteWS('${tid}')" style="color:var(--danger); cursor:pointer;">××—×§</span>
                            </div>` : ''}
                        </div>`;
                    
                    if(isDone) archiveContainer.innerHTML += html;
                    else activeContainer.innerHTML += html;
                });
            });
        });
    }

    window.toggleTask = async (tid, isDone) => {
        await setDoc(doc(db, "submissions", student + "_" + tid), { 
            studentName: student, taskId: tid, completed: !isDone, classCode: classCode 
        });
    };

    window.uploadWS = (id) => {
        const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*';
        inp.onchange = (e) => {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                await updateDoc(doc(db, "tasks", id), { worksheets: [ev.target.result], worksheetBy: student });
                alert("×”×•×¢×œ×” ×‘×”×¦×œ×—×”!");
            };
            reader.readAsDataURL(e.target.files[0]);
        };
        inp.click();
    };

    window.viewWS = async (id) => {
        const d = await getDocs(collection(db, "tasks"));
        const t = d.docs.find(doc => doc.id === id).data();
        document.getElementById('wsGrid').innerHTML = t.worksheets.map(img => `<img src="${img}" style="width:100%; border-radius:10px; margin-bottom:10px;">`).join('');
        document.getElementById('wsViewModal').style.display = 'block';
    };

    window.deleteWS = async (id) => { if(confirm("×œ××—×•×§ ×“×¤×™× ×©×œ×š?")) await updateDoc(doc(db, "tasks", id), { worksheets: null, worksheetBy: null }); };
    window.zoom = (url) => { document.getElementById('modalImg').src = url; document.getElementById('imgModal').style.display = 'block'; };
    window.logout = () => { localStorage.clear(); location.reload(); };
    function updateActivity() { setDoc(doc(db, "activity", student + "_" + classCode), { name: student, classCode, lastSeen: serverTimestamp() }, { merge: true }); }
    
    window.onload = () => { if(localStorage.getItem('studentName')) enterClass(); };
</script>
</body>
</html>
