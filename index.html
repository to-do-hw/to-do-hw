<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>×¨××œ×™ ××˜×•"×¡ - ×××©×§ ×ª×œ××™×“×™× ××œ×</title>
<style>
    :root {
        --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #4338ca 100%);
        --glass: rgba(255, 255, 255, 0.12);
        --glass-border: rgba(255, 255, 255, 0.25);
        --accent: #10b981;
        --danger: #ef4444;
        --sun-color: #fbbf24; --mon-color: #f87171; --tue-color: #34d399; --wed-color: #60a5fa; --thu-color: #c084fc;
    }

    body {
        font-family: -apple-system, system-ui, sans-serif;
        margin: 0; padding: 15px; direction: rtl; min-height: 100vh;
        background: var(--bg-gradient); background-size: 400% 400%;
        color: white; overflow-x: hidden;
    }

    .glass-panel {
        background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 30px; border: 1px solid var(--glass-border); padding: 25px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3); margin-bottom: 20px;
    }

    input {
        width: 100%; padding: 18px; margin-bottom: 15px; border-radius: 18px; border: none;
        background: rgba(255,255,255,0.1); color: white; font-size: 18px; box-sizing: border-box;
    }

    .btn-primary {
        width: 100%; padding: 18px; border-radius: 18px; border: none;
        background: white; color: #1e3a8a; font-weight: 900; font-size: 18px; cursor: pointer;
        transition: 0.3s;
    }

    .task-card {
        background: rgba(255, 255, 255, 0.15); border-radius: 25px; padding: 20px;
        margin-bottom: 20px; border: 1px solid var(--glass-border); position: relative;
    }

    .status-badge {
        padding: 8px 15px; border-radius: 12px; font-weight: bold; font-size: 14px;
        display: inline-block; margin-bottom: 10px;
    }

    .done { background: var(--accent); color: white; }
    .pending { background: var(--danger); color: white; }

    .img-preview { width: 100%; border-radius: 20px; margin-top: 10px; border: 1px solid var(--glass-border); cursor: zoom-in; }

    /* ××¢×¨×›×ª ×©×¢×•×ª ×¦×‘×¢×•× ×™×ª */
    .schedule-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scroll-snap-type: x mandatory; }
    .day-col { 
        min-width: 150px; background: rgba(0,0,0,0.25); border-radius: 22px; padding: 15px; 
        scroll-snap-align: start; flex: 1; border: 1px solid rgba(255,255,255,0.1);
    }
    .lesson-box {
        background: rgba(255,255,255,0.08); border-radius: 15px; padding: 10px; margin-top: 10px;
        font-size: 14px; text-align: center; border-right: 4px solid white;
    }

    .hidden { display: none; }

    /* ×”×ª×¨××•×ª ×•×‘×× ×¨×™× */
    #notifBanner {
        background: var(--accent); color: white; padding: 12px; text-align: center;
        border-radius: 15px; margin-bottom: 15px; font-weight: bold; 
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); animation: slideDown 0.5s ease;
    }

    @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

    /* ××•×“×œ×™× */
    .modal {
        display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); overflow-y: auto;
    }
    .modal-content { max-width: 90%; margin: 40px auto; position: relative; }
    .modal img { width: 100%; border-radius: 15px; }
</style>
</head>
<body>

<div class="container">
    <div id="loginArea" class="glass-panel">
        <h1 style="text-align:center;">×¨××œ×™ ××˜×•"×¡ ğŸš€</h1>
        <p style="text-align:center; opacity:0.8;">×”×ª×—×‘×¨×•×ª ×ª×œ××™×“</p>
        <input type="text" id="studentName" placeholder="×©× ××œ×">
        <input type="text" id="classCode" placeholder="×§×•×“ ×›×™×ª×”">
        <button class="btn-primary" onclick="enterClass()">×›× ×™×¡×” ×œ×©×™×¢×•×¨</button>
    </div>

    <div id="taskArea" class="hidden">
        <div id="notifBanner" class="hidden">ğŸ”” ××©×™××” ×—×“×©×” ×¤×•×¨×¡××”! ×¨×¢× × ×• ××ª ×”×¨×©×™××”</div>
        
        <div class="glass-panel" style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="helloTitle" style="margin:0;">×©×œ×•× ×ª×œ××™×“</h3>
            <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:12px; font-weight:bold; cursor:pointer;">×™×¦×™××”</button>
        </div>

        <div class="glass-panel">
            <h4 style="margin-top:0;">ğŸ“… ××¢×¨×›×ª ×©×¢×•×ª</h4>
            <div id="scheduleContainer" class="schedule-grid"></div>
        </div>

        <h4 style="margin-right:10px;">ğŸ“‹ ×”××©×™××•×ª ×©×œ×™</h4>
        <div id="taskList"></div>
    </div>
</div>

<div id="imgModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content"><img id="modalImg" src=""></div>
</div>

<div id="wsViewModal" class="modal">
    <div class="modal-content">
        <h2 style="color:white; text-align:center;">×“×¤×™ ×¢×‘×•×“×” ×©×”×¢×œ×™×ª</h2>
        <div id="wsGrid"></div>
        <button class="btn-primary" onclick="document.getElementById('wsViewModal').style.display='none'" style="margin-top:20px;">×¡×’×•×¨ ×ª×¦×•×’×”</button>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDocs, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ×”×’×“×¨×•×ª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDvnS8L9r2LMKcUD78Ix7bldVp9qzbYwtk",
        authDomain: "tast-7808e.firebaseapp.com",
        projectId: "tast-7808e",
        storageBucket: "tast-7808e.firebasestorage.app",
        messagingSenderId: "99024860024",
        appId: "1:99024860024:web:24ab70c10254a2014fce8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let student = "", classCode = "";

    // ×¤×•× ×§×¦×™×™×ª ×”×ª×¨××•×ª (×× ×™×¢×ª ×ª×œ×•× ×•×ª ×ª×œ××™×“×™×)
    async function requestNotifs() {
        if ("Notification" in window && Notification.permission !== "granted") {
            await Notification.requestPermission();
        }
    }

    // ×›× ×™×¡×” ×œ××¢×¨×›×ª
    window.enterClass = async () => {
        student = document.getElementById('studentName').value.trim();
        classCode = document.getElementById('classCode').value.trim().toUpperCase();
        
        if(!student || !classCode) return alert("××œ× ×©× ×•×§×•×“ ×›×™×ª×”");

        const q = query(collection(db, "classes"), where("code", "==", classCode));
        const snap = await getDocs(q);
        
        if(snap.empty) return alert("×§×•×“ ×›×™×ª×” ×œ× × ××¦× ×‘××¢×¨×›×ª");

        localStorage.setItem('studentName', student);
        localStorage.setItem('classCode', classCode);
        
        document.getElementById('loginArea').classList.add('hidden');
        document.getElementById('taskArea').classList.remove('hidden');
        document.getElementById('helloTitle').innerText = `×”×™×™, ${student} ğŸ‘‹`;

        requestNotifs();
        startApp();
    };

    function startApp() {
        loadSchedule();
        loadTasks();
        listenNotifications();
        updateActivity();
        setInterval(updateActivity, 120000); // ×¢×“×›×•×Ÿ × ×•×›×—×•×ª ×›×œ 2 ×“×§×•×ª
    }

    // ×”××–× ×” ×œ×”×ª×¨××•×ª ××©×™××” ×—×“×©×”
    function listenNotifications() {
        const q = query(collection(db, "notifications"), where("classCode", "==", classCode));
        onSnapshot(q, (snap) => {
            snap.docChanges().forEach(change => {
                if(change.type === "added") {
                    const data = change.doc.data();
                    const isRecent = (Date.now() - data.timestamp?.toMillis()) < 15000;
                    if(isRecent) {
                        document.getElementById('notifBanner').classList.remove('hidden');
                        if(Notification.permission === "granted") {
                            new Notification("××©×™××” ×—×“×©×” ××”××•×¨×”!", { body: data.body });
                        }
                    }
                }
            });
        });
    }

    // ×˜×¢×™× ×ª ××¢×¨×›×ª ×©×¢×•×ª ×¦×‘×¢×•× ×™×ª
    function loadSchedule() {
        onSnapshot(query(collection(db, "classes"), where("code", "==", classCode)), (snap) => {
            if(snap.empty) return;
            const data = snap.docs[0].data().schedule || {};
            const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™"];
            const colors = ["--sun-color", "--mon-color", "--tue-color", "--wed-color", "--thu-color"];
            
            document.getElementById('scheduleContainer').innerHTML = days.map((day, i) => {
                const lessons = data[`day${i}`] || [];
                return `<div class="day-col">
                    <b style="color:var(${colors[i]})">${day}</b>
                    ${lessons.map(l => `<div class="lesson-box" style="border-color:var(${colors[i]})"><b>${l.subject}</b><br>${l.time}</div>`).join('')}
                </div>`;
            }).join('');
        });
    }

    // ×˜×¢×™× ×ª ××©×™××•×ª ×•×”×’×©×•×ª (×¡× ×›×¨×•×Ÿ ××œ×)
    function loadTasks() {
        onSnapshot(query(collection(db, "tasks"), where("classCode", "==", classCode)), (tSnap) => {
            onSnapshot(query(collection(db, "submissions"), where("studentName", "==", student)), (sSnap) => {
                const subs = {};
                sSnap.forEach(d => { if(d.data().completed) subs[d.data().taskId] = true; });

                const list = document.getElementById('taskList');
                let tasks = [];
                tSnap.forEach(d => tasks.push({id: d.id, ...d.data()}));
                tasks.sort((a,b) => a.endTime - b.endTime);

                list.innerHTML = tasks.map(t => {
                    const isDone = subs[t.id] || false;
                    const hasWS = t.worksheetBy === student;
                    return `
                    <div class="task-card">
                        <span class="status-badge ${isDone?'done':'pending'}">${isDone?'×‘×•×¦×¢ âœ…':'×œ×‘×™×¦×•×¢ â³'}</span>
                        <h3 style="margin:10px 0;">${t.title}</h3>
                        ${t.imageUrl ? `<img src="${t.imageUrl}" class="img-preview" onclick="zoom('${t.imageUrl}')">` : ''}
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                            <button class="btn-primary" onclick="toggleTask('${t.id}', ${isDone})" style="background:${isDone?'rgba(255,255,255,0.2)':'var(--accent)'}; color:white; font-size:14px; padding:12px;">
                                ${isDone ? '×‘×™×˜×•×œ ×¡×™××•×Ÿ' : '×¡×™×™××ª×™! âœ…'}
                            </button>
                            <button class="btn-primary" onclick="uploadWS('${t.id}')" style="background:rgba(255,255,255,0.1); color:white; border:1px solid white; font-size:14px; padding:12px;">
                                ğŸ“¸ ×”×¢×œ××ª ×“×¤×™×
                            </button>
                        </div>
                        ${hasWS ? `<div style="text-align:center; margin-top:10px; font-size:13px;">
                            <span onclick="viewWS('${t.id}')" style="color:var(--accent); text-decoration:underline; cursor:pointer;">×¦×¤×™×™×” ×‘×“×¤×™× ×©×œ×™</span> | 
                            <span onclick="deleteWS('${t.id}')" style="color:var(--danger); text-decoration:underline; cursor:pointer;">××—×™×§×”</span>
                        </div>` : ''}
                    </div>`;
                }).join('');
            });
        });
    }

    // ×¤×•× ×§×¦×™×•×ª ×œ×™×‘×” (×“×¤×™ ×¢×‘×•×“×”, ×–×•×, × ×•×›×—×•×ª)
    window.uploadWS = (id) => {
        const inp = document.createElement('input');
        inp.type = 'file'; inp.accept = 'image/*';
        inp.onchange = async (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const b64 = ev.target.result;
                await updateDoc(doc(db, "tasks", id), { worksheets: [b64], worksheetBy: student });
                alert("×”×“×¤×™× ×”×•×¢×œ×• ×‘×”×¦×œ×—×”!");
            };
            reader.readAsDataURL(file);
        };
        inp.click();
    };

    window.viewWS = async (id) => {
        const snap = await getDocs(collection(db, "tasks"));
        const t = snap.docs.find(d => d.id === id).data();
        document.getElementById('wsGrid').innerHTML = (t.worksheets || []).map(img => `<img src="${img}" style="margin-bottom:10px; border-radius:15px; width:100%;">`).join('');
        document.getElementById('wsViewModal').style.display = 'block';
    };

    window.deleteWS = async (id) => { 
        if(confirm("×œ××—×•×§ ××ª ×“×¤×™ ×”×¢×‘×•×“×” ×©×”×¢×œ×™×ª?")) {
            await updateDoc(doc(db, "tasks", id), { worksheets: null, worksheetBy: null }); 
        }
    };

    window.toggleTask = async (tid, isDone) => {
        await setDoc(doc(db, "submissions", student + "_" + tid), { 
            studentName: student, taskId: tid, completed: !isDone, classCode: classCode 
        });
    };

    window.zoom = (url) => { 
        document.getElementById('modalImg').src = url; 
        document.getElementById('imgModal').style.display = 'block'; 
    };

    function updateActivity() {
        setDoc(doc(db, "activity", student + "_" + classCode), { 
            name: student, classCode: classCode, lastSeen: serverTimestamp() 
        }, { merge: true });
    }

    window.logout = () => { localStorage.clear(); location.reload(); };

    window.onload = () => {
        const n = localStorage.getItem('studentName'), c = localStorage.getItem('classCode');
        if(n && c) {
            document.getElementById('studentName').value = n;
            document.getElementById('classCode').value = c;
            enterClass();
        }
    };
</script>
</body>
</html>
